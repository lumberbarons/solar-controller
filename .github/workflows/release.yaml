name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write

env:
  GO_VERSION: '1.24'
  NODE_VERSION: '22'

jobs:
  build-frontend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Set up Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Build frontend
        run: make build-frontend

      - name: Upload site build artifacts
        uses: actions/upload-artifact@v5
        with:
          name: site-build
          path: internal/static/build
          retention-days: 1

  build-binaries:
    runs-on: ${{ matrix.runner }}
    needs: build-frontend
    strategy:
      matrix:
        include:
          - os: linux
            arch: amd64
            runner: ubuntu-24.04
          - os: linux
            arch: arm64
            runner: ubuntu-24.04-arm
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Fetch all tags
        run: git fetch --force --tags

      - name: Download site build artifacts
        uses: actions/download-artifact@v6
        with:
          name: site-build
          path: internal/static/build

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Extract version information
        id: version
        run: |
          echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          echo "GIT_COMMIT=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "BUILD_TIME=$(date -u '+%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT

      - name: Build binary with CGO
        env:
          CGO_ENABLED: 1
          GOOS: ${{ matrix.os }}
          GOARCH: ${{ matrix.arch }}
        run: |
          go build \
            -ldflags="-s -w -X 'main.Version=${{ steps.version.outputs.VERSION }}' -X 'main.BuildTime=${{ steps.version.outputs.BUILD_TIME }}' -X 'main.GitCommit=${{ steps.version.outputs.GIT_COMMIT }}'" \
            -trimpath \
            -o bin/solar-controller \
            ./cmd/controller

      - name: Create tarball
        run: |
          cd bin
          tar -czf solar-controller_${{ matrix.os }}_${{ matrix.arch }}.tar.gz solar-controller
          cd ..

      - name: Upload binary artifacts
        uses: actions/upload-artifact@v5
        with:
          name: binary-${{ matrix.os }}-${{ matrix.arch }}
          path: |
            bin/solar-controller
            bin/solar-controller_${{ matrix.os }}_${{ matrix.arch }}.tar.gz
          retention-days: 1

  build-packages:
    runs-on: ${{ matrix.runner }}
    needs: build-binaries
    strategy:
      matrix:
        include:
          - os: linux
            arch: amd64
            runner: ubuntu-24.04
            nfpm_arch: amd64
          - os: linux
            arch: arm64
            runner: ubuntu-24.04-arm
            nfpm_arch: arm64
        format: [deb, rpm]
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Download binary artifacts
        uses: actions/download-artifact@v6
        with:
          name: binary-${{ matrix.os }}-${{ matrix.arch }}
          path: bin

      - name: Make binary executable
        run: chmod +x bin/solar-controller

      - name: Install nfpm
        run: |
          echo 'deb [trusted=yes] https://repo.goreleaser.com/apt/ /' | sudo tee /etc/apt/sources.list.d/goreleaser.list
          sudo apt update
          sudo apt install -y nfpm

      - name: Extract version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Create ${{ matrix.format }} package
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
          ARCH: ${{ matrix.nfpm_arch }}
        run: |
          mkdir -p dist
          nfpm package --packager ${{ matrix.format }} --target dist/

      - name: Upload package artifacts
        uses: actions/upload-artifact@v5
        with:
          name: package-${{ matrix.format }}-${{ matrix.arch }}
          path: dist/*.${{ matrix.format }}
          retention-days: 1

  create-release:
    runs-on: ubuntu-latest
    needs: [build-binaries, build-packages, docker-manifest]
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Download binary artifacts
        uses: actions/download-artifact@v6
        with:
          pattern: binary-*
          path: artifacts

      - name: Download package artifacts
        uses: actions/download-artifact@v6
        with:
          pattern: package-*
          path: artifacts

      - name: Organize release assets
        run: |
          mkdir -p release-assets
          # Copy tarballs
          find artifacts/binary-* -name "*.tar.gz" -exec cp {} release-assets/ \;
          # Copy packages
          find artifacts/package-* -name "*.deb" -exec cp {} release-assets/ \;
          find artifacts/package-* -name "*.rpm" -exec cp {} release-assets/ \;

      - name: Generate checksums
        working-directory: release-assets
        run: |
          sha256sum * > checksums.txt

      - name: Extract version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Generate release notes
        id: notes
        run: |
          cat > release-notes.md << 'EOF'
          ## Installation Instructions

          ### Binary Installation

          Download the appropriate archive for your platform from the assets below and extract it:

          ```bash
          # Linux x86_64
          tar -xzf solar-controller_linux_amd64.tar.gz

          # Linux ARM64
          tar -xzf solar-controller_linux_arm64.tar.gz
          ```

          Then run the binary with your configuration file:

          ```bash
          ./solar-controller -config /path/to/config.yaml
          ```

          ### Package Manager Installation

          **Debian/Ubuntu:**
          ```bash
          sudo dpkg -i solar-controller_*_amd64.deb
          # or for ARM64
          sudo dpkg -i solar-controller_*_arm64.deb
          ```

          **Red Hat/CentOS/Fedora:**
          ```bash
          sudo rpm -i solar-controller-*.x86_64.rpm
          # or for ARM64
          sudo rpm -i solar-controller-*.aarch64.rpm
          ```

          Package installations include systemd service configuration. Edit `/etc/solar-controller/config.yaml` and then:
          ```bash
          sudo systemctl enable solar-controller
          sudo systemctl start solar-controller
          ```

          ### Docker

          Docker images are published to GitHub Container Registry:

          ```bash
          # Pull the latest version
          docker pull ghcr.io/lumberbarons/solar-controller:latest

          # Or pull a specific version
          docker pull ghcr.io/lumberbarons/solar-controller:${{ steps.version.outputs.VERSION }}

          # Run with configuration file mounted
          docker run -d \
            --name solar-controller \
            --device=/dev/ttyXRUSB0:/dev/ttyXRUSB0 \
            -v /path/to/config.yaml:/etc/solar-controller/config.yaml:ro \
            -p 8080:8080 \
            ghcr.io/lumberbarons/solar-controller:latest \
            -config /etc/solar-controller/config.yaml
          ```

          **Note:** Adjust `--device` flag to match your serial device path.

          ### Configuration

          See the [example configuration](https://github.com/lumberbarons/solar-controller/blob/main/package/config.yaml) for all available options.

          ## Changes

          EOF

          # Add commit log since last tag
          git log $(git describe --tags --abbrev=0 HEAD^)..HEAD --pretty=format:"- %s" | grep -v '^docs:' | grep -v '^test:' >> release-notes.md || echo "- Initial release" >> release-notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release-assets/*
          body_path: release-notes.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-docker:
    runs-on: ${{ matrix.runner }}
    needs: [build-frontend, build-binaries]
    strategy:
      matrix:
        include:
          - platform: linux/amd64
            runner: ubuntu-24.04
            arch: amd64
          - platform: linux/arm64
            runner: ubuntu-24.04-arm
            arch: arm64
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Download site build artifacts
        uses: actions/download-artifact@v6
        with:
          name: site-build
          path: internal/static/build

      - name: Download binary artifacts
        uses: actions/download-artifact@v6
        with:
          name: binary-linux-${{ matrix.arch }}
          path: bin

      - name: Make binary executable
        run: chmod +x bin/solar-controller

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}

      - name: Build and push ${{ matrix.arch }} image
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: ${{ matrix.platform }}
          push: true
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=${{ matrix.arch }}
          cache-to: type=gha,mode=max,scope=${{ matrix.arch }}
          outputs: type=image,name=ghcr.io/${{ github.repository }},push-by-digest=true,name-canonical=true,push=true

      - name: Export digest
        run: |
          mkdir -p /tmp/digests
          digest="${{ steps.build.outputs.digest }}"
          touch /tmp/digests/${digest#sha256:}

      - name: Upload digest
        uses: actions/upload-artifact@v5
        with:
          name: digests-${{ matrix.arch }}
          path: /tmp/digests/*
          if-no-files-found: error
          retention-days: 1

      - name: Cleanup orphaned images on failure
        if: failure()
        uses: dataaxiom/ghcr-cleanup-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          delete-untagged: true
          delete-ghost-images: true

  docker-manifest:
    runs-on: ubuntu-latest
    needs: build-docker
    steps:
      - name: Download digests
        uses: actions/download-artifact@v6
        with:
          path: /tmp/digests
          pattern: digests-*
          merge-multiple: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest

      - name: Create manifest list and push
        working-directory: /tmp/digests
        run: |
          docker buildx imagetools create $(jq -cr '.tags | map("-t " + .) | join(" ")' <<< "$DOCKER_METADATA_OUTPUT_JSON") \
            $(printf 'ghcr.io/${{ github.repository }}@sha256:%s ' *)

      - name: Inspect image
        run: |
          docker buildx imagetools inspect ghcr.io/${{ github.repository }}:${{ steps.meta.outputs.version }}
